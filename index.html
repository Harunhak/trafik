<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bursa Trafik Işığı Takip</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .menu {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 5px;
        }
        button { cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

<div class="menu">
    <b>Bursa Trafik Takip</b>
    <button onclick="exportLights()">Verileri Kopyala (Telefona At)</button>
    <button onclick="importLights()">Veri Yapıştır (Telefondan Yükle)</button>
    <button onclick="if(confirm('Hepsi silinsin mi?')) { localStorage.clear(); location.reload(); }">Hepsini Sil</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Bursa Koordinatları ve Sınırları
    var bursaMerkez = [40.1885, 29.0610];
    var bursaSinir = [
        [40.00, 28.50], // Güney Batı
        [40.40, 29.60]  // Kuzey Doğu
    ];

    var map = L.map('map', {
        maxBounds: bursaSinir, // Haritayı Bursa ile sınırla
        maxBoundsViscosity: 1.0
    }).setView(bursaMerkez, 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© Bursa Trafik Takip'
    }).addTo(map);

    var savedLights = JSON.parse(localStorage.getItem('bursaLights')) || [];

    // Kayıtlı ışıkları yükle
    savedLights.forEach(l => createLight(l.lat, l.lng, l.red, l.green, false));

    map.on('click', function(e) {
        var red = prompt("Kırmızı ışık süresi (sn):", "30");
        var green = prompt("Yeşil ışık süresi (sn):", "20");
        if (red && green) {
            createLight(e.latlng.lat, e.latlng.lng, parseInt(red), parseInt(green), true);
        }
    });

    function createLight(lat, lng, redT, greenT, isNew) {
        var marker = L.circleMarker([lat, lng], { radius: 15, color: 'red', fillOpacity: 0.8 }).addTo(map);
        var data = { status: 'KIRMIZI', time: redT };

        if (isNew) {
            savedLights.push({lat, lng, red: redT, green: greenT});
            localStorage.setItem('bursaLights', JSON.stringify(savedLights));
        }

        setInterval(() => {
            data.time--;
            if (data.time <= 0) {
                if (data.status === 'KIRMIZI') {
                    data.status = 'YEŞİL'; data.time = greenT; marker.setStyle({color: 'green'});
                } else {
                    data.status = 'KIRMIZI'; data.time = redT; marker.setStyle({color: 'red'});
                }
            }
            marker.setTooltipContent(data.status + ": " + data.time + "s");
        }, 1000);

        marker.bindTooltip(data.status + ": " + data.time + "s", {permanent: true});
        
        marker.on('click', function() {
            data.status = 'KIRMIZI';
            data.time = redT;
            marker.setStyle({color: 'red'});
        });
    }

    // VERİ AKTARMA FONKSİYONLARI
    function exportLights() {
        const data = localStorage.getItem('bursaLights');
        if(data) {
            navigator.clipboard.writeText(data);
            alert("Işık verileri panoya kopyalandı! Bu metni kendinize WhatsApp'tan atın ve telefonda 'Veri Yapıştır' diyerek yükleyin.");
        } else {
            alert("Henüz kayıtlı ışık yok.");
        }
    }

    function importLights() {
        const data = prompt("WhatsApp'tan kopyaladığınız kodu buraya yapıştırın:");
        if(data) {
            localStorage.setItem('bursaLights', data);
            location.reload();
        }
    }
</script>
</body>
</html>
