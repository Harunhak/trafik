<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bursa Canlı Trafik</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .status { position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="status" id="db-status">Buluta Bağlanılıyor...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- KENDİ BİLGİLERİNİ BURAYA YAPIŞTIR ---
    const firebaseConfig = {
        apiKey: "AIzaSyAgfkGI82dqs8fa_sqQjWl1ZcIf9AJDEes",
        authDomain: "trafik-2291d.firebaseapp.com",
        databaseURL: "https://trafik-2291d-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "trafik-2291d",
        storageBucket: "trafik-2291d.firebasestorage.app",
        messagingSenderId: "119089745586",
        appId: "1:119089745586:web:ef1e7280435a4aa918c3ab",
        measurementId: "G-6TF54HZHVS"
    };
    // ------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const statusDiv = document.getElementById('db-status');

    var map = L.map('map').setView([40.1885, 29.0610], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Veritabanından ışıkları oku
    db.ref('lights').on('value', (snapshot) => {
        statusDiv.innerText = "Bulut Bağlantısı Aktif";
        // Haritayı temizle ve yeniden çiz (basit yöntem)
        map.eachLayer((layer) => { if (!!layer.toGeoJSON && !layer._url) map.removeLayer(layer); });
        
        const data = snapshot.val();
        for (let id in data) {
            renderLight(id, data[id]);
        }
    });

    marker.on('click', function() {
    const action = confirm("Bu ışık için ne yapmak istersiniz?\n\nTAMAM: Işığı Kırmızıya Sıfırla (Senkronize Et)\nİPTAL: Işığı Tamamen Sil");
    
    if (action) {
        // Tamam'a basılırsa: Sadece zamanı sıfırla
        db.ref('lights/' + id).update({ startTime: Date.now() });
    } else {
        // İptal'e basılırsa: Silmek isteyip istemediğini bir daha sor
        if(confirm("Emin misiniz? Bu ışık tüm cihazlardan silinecek.")) {
            db.ref('lights/' + id).remove(); // Firebase'den siler
        }
    }
});

    function renderLight(id, light) {
        var marker = L.circleMarker([light.lat, light.lng], { radius: 15, color: 'red', fillOpacity: 0.8 }).addTo(map);
        
        setInterval(() => {
            const now = Date.now();
            const elapsed = Math.floor((now - light.startTime) / 1000);
            const totalCycle = light.red + light.green;
            const cyclePos = elapsed % totalCycle;

            let currentStatus, remaining;
            if (cyclePos < light.red) {
                currentStatus = 'KIRMIZI';
                remaining = light.red - cyclePos;
                marker.setStyle({color: 'red'});
            } else {
                currentStatus = 'YEŞİL';
                remaining = totalCycle - cyclePos;
                marker.setStyle({color: 'green'});
            }
            marker.setTooltipContent(`${currentStatus}: ${remaining}s`);
        }, 1000);

        marker.bindTooltip("Yükleniyor...", {permanent: true});

        // Işığa tıklandığında süreyi sıfırla (Bulutu güncelle)
        marker.on('click', function() {
            db.ref('lights/' + id).update({ startTime: Date.now() });
        });
    }
</script>
</body>
</html>

