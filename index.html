<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bursa CanlÄ± Trafik Takip</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .status-box {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; font-size: 13px;
        }
        .popup-btn {
            width: 100%; border: none; color: white; padding: 8px;
            margin-top: 5px; cursor: pointer; border-radius: 4px; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="status-box" id="db-status">Buluta BaÄŸlanÄ±lÄ±yor...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- BURAYI KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR (Firebase -> Proje AyarlarÄ±) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAgfkGI82dqs8fa_sqQjWl1ZcIf9AJDEes",
        authDomain: "trafik-2291d.firebaseapp.com",
        databaseURL: "https://trafik-2291d-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "trafik-2291d",
        storageBucket: "trafik-2291d.firebasestorage.app",
        messagingSenderId: "119089745586",
        appId: "1:119089745586:web:ef1e7280435a4aa918c3ab",
        measurementId: "G-6TF54HZHVS"
    };
    // ------------------------------------------------------------------

    // Firebase'i BaÅŸlat
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const statusDiv = document.getElementById('db-status');

    // Bursa OdaklÄ± Harita
    var map = L.map('map', {
        maxBounds: [[39.90, 28.40], [40.50, 29.80]], // Bursa dÄ±ÅŸÄ±na kaymayÄ± engelle
        maxBoundsViscosity: 1.0
    }).setView([40.1885, 29.0610], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© Bursa Trafik Takip'
    }).addTo(map);

    // Buluttan Verileri Ã‡ek ve GerÃ§ek ZamanlÄ± Dinle
    db.ref('lights').on('value', (snapshot) => {
        statusDiv.innerText = "ğŸŸ¢ Bulut BaÄŸlantÄ±sÄ± Aktif";
        statusDiv.style.color = "green";
        
        // Mevcut markerlarÄ± temizle (Yeniden Ã§izim iÃ§in)
        map.eachLayer((layer) => {
            if (layer instanceof L.CircleMarker) map.removeLayer(layer);
        });
        
        const data = snapshot.val();
        if (data) {
            for (let id in data) {
                renderLight(id, data[id]);
            }
        }
    }, (error) => {
        statusDiv.innerText = "ğŸ”´ BaÄŸlantÄ± HatasÄ±: " + error.message;
        statusDiv.style.color = "red";
    });

    // Haritaya TÄ±klayÄ±nca Yeni IÅŸÄ±k Ekle
    map.on('click', function(e) {
        var red = prompt("KÄ±rmÄ±zÄ± Ä±ÅŸÄ±k sÃ¼resi (saniye):", "30");
        var green = prompt("YeÅŸil Ä±ÅŸÄ±k sÃ¼resi (saniye):", "20");
        
        if (red && green) {
            const newLightRef = db.ref('lights').push();
            newLightRef.set({
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                red: parseInt(red),
                green: parseInt(green),
                startTime: Date.now()
            });
        }
    });

    // IÅŸÄ±ÄŸÄ± Haritada Ã‡iz ve Ã‡alÄ±ÅŸtÄ±r
    function renderLight(id, light) {
        var marker = L.circleMarker([light.lat, light.lng], {
            radius: 12, color: 'red', fillOpacity: 0.9, weight: 3
        }).addTo(map);

        // Her saniye Ä±ÅŸÄ±k rengini hesapla
        const timerInterval = setInterval(() => {
            const now = Date.now();
            const elapsed = Math.floor((now - light.startTime) / 1000);
            const totalCycle = light.red + light.green;
            const cyclePos = elapsed % totalCycle;

            let statusText, remaining;
            if (cyclePos < light.red) {
                statusText = "KIRMIZI";
                remaining = light.red - cyclePos;
                marker.setStyle({color: 'red', fillColor: 'red'});
            } else {
                statusText = "YEÅÄ°L";
                remaining = totalCycle - cyclePos;
                marker.setStyle({color: 'green', fillColor: 'green'});
            }
            
            if (marker.getTooltip()) {
                marker.setTooltipContent(`${statusText}: ${remaining}s`);
            }
        }, 1000);

        marker.bindTooltip("HesaplanÄ±yor...", {permanent: true, direction: 'top', offset: [0, -10]});

        // IÅŸÄ±ÄŸa TÄ±klayÄ±nca Kontrol Paneli (SÄ±fÄ±rla/Sil)
        const popupHtml = `
            <div style="min-width:120px;">
                <b style="display:block;margin-bottom:8px;text-align:center;">IÅŸÄ±k YÃ¶netimi</b>
                <button onclick="resetLight('${id}')" class="popup-btn" style="background:#f39c12;">ğŸ”´ SÄ±fÄ±rla (KÄ±rmÄ±zÄ±)</button>
                <button onclick="deleteLight('${id}')" class="popup-btn" style="background:#e74c3c;">ğŸ—‘ï¸ IÅŸÄ±ÄŸÄ± Sil</button>
            </div>
        `;
        marker.bindPopup(popupHtml);

        // Marker silindiÄŸinde sayacÄ± durdur (bellek yÃ¶netimi)
        marker.on('remove', () => clearInterval(timerInterval));
    }

    // --- Global Fonksiyonlar ---
    window.resetLight = function(id) {
        db.ref('lights/' + id).update({ startTime: Date.now() });
        map.closePopup();
    };

    window.deleteLight = function(id) {
        if(confirm("Bu Ä±ÅŸÄ±ÄŸÄ± silmek istediÄŸinize emin misiniz?")) {
            db.ref('lights/' + id).remove();
        }
    };

</script>
</body>
</html>
